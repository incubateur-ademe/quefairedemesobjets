on:
  workflow_call:
    inputs:
      container_key:
        type: string
        required: true
      registry_image:
        type: string
        required: true
jobs:
  deploy_container:
    name: Scaleway deploy container
    runs-on: ubuntu-slim
    env:
      SCALEWAY_DEPLOY_KEY: ${{ secrets.SCALEWAY_DEPLOY_KEY }}
      CONTAINER_ID: ${{ vars[inputs.container_key] }}
      REGISTRY_IMAGE: ${{ inputs.registry_image }}
    steps:
    - name: Setup Scaleway CLI
      uses: scaleway/action-scw@be2696f261325a78354eda14988c80405f33e082

    # See https://www.scaleway.com/en/docs/serverless-containers/api-cli/deploy-container-cli/
    - name: Update image
      run: |
        scw container container update $CONTAINER_ID \
          registry-image=$REGISTRY_IMAGE \
          region=fr-par
      env:
        SCW_ACCESS_KEY: ${{ secrets.SCW_ACCESS_KEY }}
        SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
        SCW_DEFAULT_PROJECT_ID: ${{ secrets.SCW_DEFAULT_PROJECT_ID }}
        SCW_DEFAULT_ORGANIZATION_ID: ${{ secrets.SCW_DEFAULT_ORGANIZATION_ID }}
        SCW_DEFAULT_REGION: fr-par

        # See https://www.scaleway.com/en/docs/serverless-containers/api-cli/deploy-container-cli/
    - name: Deploy container
      run: |
        scw container container deploy $CONTAINER_ID \
          region=fr-par
      env:
        SCW_ACCESS_KEY: ${{ secrets.SCW_ACCESS_KEY }}
        SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
        SCW_DEFAULT_PROJECT_ID: ${{ secrets.SCW_DEFAULT_PROJECT_ID }}
        SCW_DEFAULT_ORGANIZATION_ID: ${{ secrets.SCW_DEFAULT_ORGANIZATION_ID }}
        SCW_DEFAULT_REGION: fr-par

    - name: Check deployment status
      run: |
        EXPECTED_VALUE="ready"
        ERROR_VALUE="error"

        while true; do
            RESPONSE_VALUE=$(scw container container get $CONTAINER_ID region=fr-par -o json | jq -r '.status')

            echo "Current status: $RESPONSE_VALUE"

            if [ "$RESPONSE_VALUE" == "$EXPECTED_VALUE" ]; then
                echo "ðŸŽ‰ The expected value '$EXPECTED_VALUE' was returned. Exiting."
                break
            fi
            if [ "$RESPONSE_VALUE" == "$ERROR_VALUE" ]; then
                echo "ðŸš¨ Ended with error : ERROR_VALUE."
                exit 1
            fi

            sleep 5
        done
      env:
        SCW_ACCESS_KEY: ${{ secrets.SCW_ACCESS_KEY }}
        SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
        SCW_DEFAULT_PROJECT_ID: ${{ secrets.SCW_DEFAULT_PROJECT_ID }}
        SCW_DEFAULT_ORGANIZATION_ID: ${{ secrets.SCW_DEFAULT_ORGANIZATION_ID }}
        SCW_DEFAULT_REGION: fr-par

# Address actions/missing-workflow-permissions rule in
# code scanning alerts
permissions:
  contents: read
