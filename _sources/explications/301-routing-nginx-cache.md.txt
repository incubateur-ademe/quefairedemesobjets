# üöè Routing, nginx et cache
Le projet est actuellement d√©ploy√© sur **Scalingo**, Scalingo qui impose une limite de 50 requ√™tes/seconde sur un worker.
Nous avons d√©cid√© d'ajouter **Nginx** en janvier 2025 afin d'agir comme serveur de cache et anticiper sur l'atteinte de cette limite.
# nginx
Dans l'hypoth√®se d'un pic de charge,
- Le **cache** de certaines **vues Django** (d√©chet / produit, page d'accueil de l'assistant...)
- Le **cache** des **fichiers statiques** (CSS, JS...)

Des images valant mille mots, ci-dessous un sch√©ma r√©sumant le parcours d'une requ√™te lorsqu'elle atteint `lvao.ademe.fr` ou `quefairedemesdechets.ademe.fr`


```{mermaid}
sequenceDiagram

participant Client
participant Nginx
participant Django



Client->>Nginx: Request lvao.ademe.fr

alt Cache Hit

Nginx-->>Client: Return cached response

else Cache Miss

Nginx->>Django: Forward request to Django

Django-->>Nginx: Generate response

alt Authenticated User

Django->>Nginx: Add 'logged_in' cookie

end

alt iframe query param present

Django->>Nginx: Add iframe cookie

end

Nginx-->>Client: Return Django response

end
```

Les cookies d√©finis expirent √† la fin de la session, cela veut dire qu'ils seront re-g√©n√©r√©s si l'utilisateur ferme son navigateur.

# whitenoise
# middleware

```{mermaid}
.. autoclasstree:: sphinx.util.DownloadFiles sphinx.util.ExtensionError
   :full:
```
